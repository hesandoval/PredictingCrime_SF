---
title: "Predicting Crime in San Francisco"
author: "Matt Boensel, Alcides Sorto, Edgar Sandoval"
date: "May 12, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Reading and Preprocessing Data
```{r}
library(sp)
library(rgdal)
library(maps)
library(raster)
library(maptools)
library(ggplot2)
library(ggmap)



crime.data <- read.csv("crime.data.final.csv")
polygon.data <- readOGR(dsn=path.expand("sf-tracts"), layer="sf-tracts")
polygon.data <- spTransform(polygon.data, CRS("+proj=longlat +datum=WGS84"))
polygon.data <- fortify(polygon.data)
```

# Data Visualization

```{r}
summary(crime.data)
dates = unlist(lapply(as.character(crime.data$Date), function(x) strsplit(x, "\\s+")[[1]][1]))
par(mar=c(5,6,3,2))
crime_dates = as.Date(dates,format = "%m/%d/%Y")
crime.data$Date = crime_dates

#plots the number of crimes reported per day of the week in jan-dec
months = unique(format(crime.data$Date, "%B"))
par(mar=c(5,6,3,2))
sapply(months, function(m) 
  barplot(table(format(crime.data$Date[format(crime.data$Date, "%B")==m], "%A")),
                                   las=2, horiz = T, main = paste("Crime for", m, "by day of the week"), xlab = "Frequency"))
#default margins
par(mar=c(5.1, 4.1, 4.1, 2.1))

#plots the categories of crimes
par(mar=c(4, 6, 1, 1)+.1)
crime_categories = unique(crime.data$Category)

#plot categories of crimes per month per day of the week
par(cex.axis=1, cex.lab=1, cex.main=1.2, cex.sub=1)
sapply(months, function(m)
  barplot(table(crime.data[format(crime.data$Date, "%B") == m,]$Category), 
          las=2, horiz=T,cex.names=.35, cex.axis = .5, main = paste("Crime Counts for", m), xlab="Frequency"))

hours = substr(crime.data$Time, 1,2)
crime.data$Hour = hours
hours=unique(hours)


#displays the times when crimes occur given their category
par(mar=c(3, 3, 2, 1)+.1)
sapply(crime_categories, function(c)
  barplot(table(crime.data[crime.data$Category == c,]$Hour), main = paste("Times when", c, "has been reported")), xlab = "Hour", ylab="Frequency")



mean.latitude = mean(crime.data$lat)
mean.longitude = mean(crime.data$lng)

san_fran = qmap(location=c(mean.longitude, mean.latitude), zoom = 13)
san_fran + stat_density2d(aes(x = lng, y = lat, fill = ..level.., alpha = ..level..), geom ="polygon",data = crime.data[as.character(crime.data$Category) == "ROBBERY",c("lat","lng","Category", "DayOfWeek")]) + scale_fill_gradient(low = "yellow", high = "red") + facet_wrap(~ DayOfWeek) + ggtitle("Locations where robbery was reported by day of the week") + geom_polygon(aes(x=long, y=lat, group=group), fill=NA, size=.2,color='black', data=polygon.data, alpha=.5)

```

# Building Model

```{r}
crime.data$output = as.numeric(crime.data$Category == "ROBBERY")

fit = glm(output ~ Events + Humidity + Conditions + TemperatureF + tract + DayOfWeek)

```