---
title: "Add Tract column to crime data"
author: "Alcides Sorto"
date: "May 5, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Load data and Libraries

```{r crime data}
rm(list=ls())
library(sp)
library(rgdal)
library(maps)
library(raster)
library(maptools)

crime.data <- read.csv("SFPD_Incidents_-_Previous_Year__2015_.csv")
#crime.locations <- read.csv("crime-coords.csv")
polygon.data <- readOGR(dsn=path.expand("sf-tracts"), layer="sf-tracts")

source("functions.r")

options(digits=16)

names = polygon.data@data$NAME10

```

## Pull crime location and id from crime.data
```{r}
crime.data.locations <- crime.data[,c("IncidntNum","Location")]
crime.locations <- data.frame(lat=c())


latt <- list()
long <- list()

res = sapply(crime.data.locations$Location, function(z){
  mach <- gregexpr("-?[[:digit:]]+\\.[[:digit:]]+", z)
  lat = latLong(z,mach,1)
  lng = latLong(z,mach,2)
  return (c(lat,lng))
})

res = t(res)
res = as.data.frame(res)
crime.data.locations = data.frame(crime.data.locations, res)
names(crime.data.locations) <- c("IncidntNum","Location","lat","lng")
crime.data.locations = crime.data.locations[,c("IncidntNum", "lat","lng")]

crime.locations <- crime.data.locations[,c("IncidntNum", "lat","lng")]

```

## Match crime location to a census tract 

```{r}

point.y <- crime.locations[,"lng"]
point.x <- crime.locations[,"lat"]



points.in <- sapply(polygon.data@polygons, function(poly){
  
  pol.y = poly@Polygons[[1]]@coords[,1]#lon
  pol.x = poly@Polygons[[1]]@coords[,2]#lat
  
  return(point.in.polygon(point.x,point.y,pol.x,pol.y, mode.checked = F))

})



points.in <- as.data.frame(points.in)

names(points.in) <- names

crime.point.which <- apply(points.in,1,function(x){ x==1} )

drop <- apply(points.in, 1, function(x){sum(x)==1})

crime.locations <- crime.locations[drop,]

crime.point.which = t(crime.point.which)

test <- (names[crime.point.which])

crime.point.which.tract <- (unlist(apply(crime.point.which,1,function(x){ as.character(names[x]) })))

crime.locations = data.frame(crime.locations,tract= crime.point.which.tract)
crime.locations$lat = NULL
crime.locations$lng = NULL

```


